什么是FOC？**

**FOC（Field-Oriented Control）**，直译是磁场定向控制，也被称作矢量控制（VC，Vector Control），是目前无刷直流电机（BLDC）和永磁同步电机（PMSM）高效控制的最优方法之一。FOC旨在通过精确地控制磁场大小与方向，使得电机的运动转矩平稳、噪声小、效率高，并且具有高速的动态响应。

简单来说就是，FOC是一种对无刷电机的驱动控制方法，它可以让我们对无刷电机进行像素级控制，实现很多传统电机控制方法所无法达到的效果~

![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-03-16-32-01-image.png)

# FOC控制过程：

1、对电机三相电流进行采样得到Ia,Ib,Ic

2、将Ia,Ib,Ic经过**Clark变换**得到Iα，Iβ

3、将Iα，Iβ经过**Park变换**得到Iq,Id

4、计算Iq,Id和其设定值Iq-ref,Id-ref的误差

5、将上述误差输入两个PID（只用到PI）控制器，得到输出的控制电压Uq,Ud

6、将Uq,Ud进行**反Park变换**，得到Uα，Uβ

7、用Uα，Uβ合成电压空间矢量，输入**SVPWM模块**进行调制，输出该时刻三个半桥的状态编码值

8、按照输出的编码值控制三相逆变器的MOS管开关，驱动电机

9、循环上述步骤

# 1.1 Clark变换

    第一步中对电机的三个相电流进行采样，这里使用串联的采样电阻进行电流采样。

> 由于电机工作的电流一般很大，所以采样电阻的阻值非常小，甚至和导线的电阻接近了，因而实际的采样电路PCB设计的时候还有一些讲究，比如使用**开尔文接法(Kelvin connections)**。

    但是实际电路设计时可以不使用三个采样器（实际有单采样电阻、双采样电阻、三采样电阻接法），只需要两个就够了。因为由基尔霍夫电流定律（KCL），在任一时刻，流入节点的电流之和等于流出节点的电流之和，也就是说

        $Ia+Ib+Ic=0$

    只需要知道其中两个就可以计算出第三个。

    这三个电流基本上就是三个相位相差120°的正弦波，再把这些信号输入控制器反馈控制之前，我们先来做点数学游戏：

    我们知道三项坐标系（$Ia，Ib，Ic$）如下：

![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-03-17-49-01-image.png?msec=1661755632557)

    而且很明显​（$Ia，Ib，Ic$）这三个基向量是非正交的，学过线性代数的同学可能会想到，我们可以做一个很简单的基变换将其正交化为一个直角坐标系，我们把新的直角坐标系命名为**​** α—β **坐标系**，变换公式如下：

![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-03-17-49-31-image.png?msec=1661755632536)

    变换前后的波形如下，可以看到变换后其实还是正弦波...只不过我们少了一个需要控制的变量了，现在只需要控制$​Iα，Iβ$这两个变量，让其满足上图的下面的波形变化规律就可以控制电机旋转了，频率还是不变的。

![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-03-17-58-43-image.png?msec=1661755632588)

> 注意这里的$ Iα，Iβ$是我们虚拟出来的变量，所以在计算出一组​ $Iα，Iβ$ 后，我们通过上述公式的反向变换公式变换回去再应用到电机的三相上。

**就这？**

        当然不是，如果只是为了减小一个控制变量那这个**变换/反变换**操作显然有点多此一举。

        有趣的是我们还可以接着变换：虽然α—β **​坐标系**下少了一维变量，但是新的变量还是非线性的（正弦），有没有办法把它们线性化呢？有的，**Park变换**就是做这个工作的。

# 1.2 Park变换

    这一步中我们接着**Clark变换**将**​坐标系**旋转$θ$度，其中$θ$ ​是**转子当前的角度**，如下图：

![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-03-18-52-53-image.png?msec=1661755632576)

    变换公式如下：

    ![](file://C:\Users\s50027046\AppData\Roaming\marktext\images\2022-08-03-18-55-23-image.png?msec=1661755632536)

    就是作用了一个旋转矩阵，写成矩阵形式：

    ![](file://C:\Users\s50027046\AppData\Roaming\marktext\images\2022-08-03-18-55-39-image.png?msec=1661755632536)

    也就是说，这个**d—q坐标系**是始终跟着转子旋转的

    这个操作是可行的，因为我们会通过编码器输入转子的实时旋转角度，所以这个角度​始终是一个已知数。经过这一步的变换，我们会发现，一个匀速旋转向量在这个坐标系下变成了一个定值！（显然的嘛，因为参考系相对于该向量静止了），这个坐标系下两个控制变量都被线性化了！下面是Park变换前后的波形：

![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-03-18-56-46-image.png?msec=1661755632576)

    接下来如果我们以  ​这两个值作为反馈控制的对象，那么显然就可以使用一些线性控制器来进行控制了，**比如PID**（是的，尽管学术界有很多炫酷的高级控制方法， 但是工业界还是偏爱PID）

# 1.3 PID控制

    在FOC中主要用到三个PID环，从内到外环依次是：**电流环**、**速度环**、**位置环。**

    也就是说：我们**通过电流反馈来控制电机电流（扭矩）** -> 然后**通过控制扭矩来控制电机的转速** -> 再**通过控制电机的转速控制电机位置**。

## 1.3.1. 电流环

    其中最内环的电流环控制框图如下：

![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-03-19-40-45-image.png?msec=1661755632558)

    可以看出来，这也就是前面提到的FOC控制9个步骤所描述的过程。实际只用到了PI控制，没有引入微分，因为如果推导一下电压和电流的传递函数会发现这其实就是一个一阶惯性环节（而且实际上我们可以通过零极点对消来简化掉PI参数，只需要控制一个参数即电流带宽即可）。

> 上图中的`Speed & Position`模块可以是编码器，或者霍尔传感器等能感应转子位置的传感器 。

    特别说明一下其中的$ Iq，Id，Iq-ref，Id-ref$，前两者大家知道是通过**Clark变换**和**Park变换**得到的，而后两者是我们预期希望前两者达到的值，这个值具体代表了什么物理量呢？参考一下下图：

![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-03-19-28-35-image.png?msec=1661755632536)

    也就是说我们一通操作将转子磁链进行了解耦，分解为了转子旋转的**径向**和**切向**这两个方向的变量：

- 其中 $Iq$ 是我们需要的，代表了期望的力矩输出
- 而 $Id$ 是我们不需要的，我们希望尽可能把它控制为0

![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-03-19-30-43-image.png?msec=1661755632537)

    通过PID控制器使用上述输入（**电流采样值、编码器位置**）和输出（MOS管开关状态）完成对电机电流的闭环控制。

## 1.3.2. 速度环

     然后进入到下一层的速度环:

![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-03-19-42-28-image.png?msec=1661755632559)

    在上图中，$Speed-ref$是速度设定值，$ω$是电机的转速反馈，可以通过电机编码器或者霍尔传感器等计算得到，依然是使用**PI控制**。

    将计算得到的电机速度$ω$与速度设定值$Speed-ref$进行误差值计算，代入**速度PI环**，计算的结果作为电流环的输入，就实现了速度-电流的双闭环控制。

## 1.3.3. 位置环

    最外一层是位置环，可以控制电机旋转到某个精确的角度并保持，控制框图如下：

![](file://C:\Users\s50027046\AppData\Roaming\marktext\images\2022-08-04-10-55-31-image.png?msec=1661755632559)

                                                           位置-速度-电流三环控制

    同理应该很简单可以理解，上图中位置控制PID只用了P项（也可以使用PI）。

    在实际使用中，由于编码器无法直接返回电机转速 $ ω$ ，因此可以通过计算一定时间内的编码值变化量来表示电机的转速（也即用**平均速度**代表**瞬时速度**）。当电机转速比较高的时候，这样的方式是可以的；但是在位置控制模式的时候，电机的转速会很慢（因为是要求转子固定在某个位置嘛），这时候用平均测速法会存在非常大的误差（转子不动或者动地很慢，编码器就没有输出或者只输出1、2个脉冲）。

    所以为了避免速度环节带来的误差，在做位置控制的时候可以只使用位置和电流组成的双环进行控制，不过此时需要对位置环做一定的变化，控制框图如下：

![](file://C:\Users\s50027046\AppData\Roaming\marktext\images\2022-08-03-19-53-58-image.png?msec=1661755632559)

    由于去掉了速度环，这里的位置环我们使用完整的**PID控制**，即把微分项加上（因为位置的微分就是速度，这样可以减小位置控制的震荡加快收敛；积分项的作用是为了消除静态误差）。

# 1.4 空间电压矢量

    什么是空间电压矢量？

    空间电压矢量是我们在控制电机过程中虚拟出来的一个矢量，既然是矢量，自然是有大小和方向的，那么它的大小和方向是什么呢？

    还是以前面**三相逆变驱动电路**那幅图中的状态为例，输入**100**的状态：

![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-04-09-29-27-image.png?msec=1661755632577)

    此时等效电路如图：

![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-04-09-29-50-image.png?msec=1661755632537)

    因此电机中三个**相电压**（相电压是每相相对于电机中间连接点的电压）可以表示为：

                                            $Ua=UA-UN=2/3Udc$

                                            $Ub=UB-UN=-1/3Udc$

                                            $Uc=UC-UN=-1/3Udc$

> 其实就是个最简单的分压电路，其中  ​是母线电压，也就是电源电压。

如果我们规定指向中心的方向为正，反之为负，那么此时我们可以画出下图中的三个电压矢量​​ ![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-04-09-34-47-image.png?msec=1661755632537)（左边），以及它们的合成电压矢量​  ![](file://C:\Users\s50027046\AppData\Roaming\marktext\images\2022-08-04-09-35-08-image.png?msec=1661755632538)（右边）：

                         ![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-04-09-35-37-image.png?msec=1661755632538)![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-04-09-36-41-image.png?msec=1661755632538)

    也就是说，这个状态下我们可以认为电机中存在一个矢量 ![](file://C:\Users\s50027046\AppData\Roaming\marktext\images\2022-08-04-09-35-08-image.png?msec=1661755632538) ​表征的电压（电流）；然后根据右手螺旋定则，可以判断出磁场的磁力线方向，也是和矢量 ![](file://C:\Users\s50027046\AppData\Roaming\marktext\images\2022-08-04-09-35-08-image.png?msec=1661755632538) ​一致的。

    再结合前面章节的分析，转子永磁体会努力旋转到内部磁力线和外部磁场方向一致，**所以这个矢量​其实就可以表征我们希望转子旋转到的方向，也即所需要生成的磁场方向了**。而这个矢量是会不断在空间中旋转的，它的幅值不变，为相电压峰值 $Udc$ ​，且以角速度 $ω=2πf$ ​匀速旋转。

    我们后面将会看到，SVPWM算法的目的，就是使用三相桥的开关状态把在空间中旋转的​矢量表示出来，我们把这个矢量称为**空间电压矢量**。

    用数学公式来表示的话就是：

    ![](file://C:\Users\s50027046\AppData\Roaming\marktext\images\2022-08-04-09-41-04-image.png?msec=1661755632538)

    为了研究各相上下桥臂不同开关组合时逆变器输出的**空间电压矢量**，我们定义开关函数 ![](file://C:\Users\s50027046\AppData\Roaming\marktext\images\2022-08-04-09-41-27-image.png?msec=1661755632538) ​为：

    ![](file://C:\Users\s50027046\AppData\Roaming\marktext\images\2022-08-04-09-41-47-image.png?msec=1661755632538)

 ![](file://C:\Users\s50027046\AppData\Roaming\marktext\images\2022-08-04-09-42-31-image.png?msec=1661755632539)的全部可能组合共有8个，包括 6个非零矢量​ ：

    ![](file://C:\Users\s50027046\AppData\Roaming\marktext\images\2022-08-04-09-42-56-image.png?msec=1661755632539)

    和两个零矢量​：

    ![](file://C:\Users\s50027046\AppData\Roaming\marktext\images\2022-08-04-09-43-16-image.png?msec=1661755632539)

    可以看出零矢量状态下电机三相间电压都为0不产生转矩（不考虑反电动势）

    下面以其中一种开关组合为例分析，假设 ![](file://C:\Users\s50027046\AppData\Roaming\marktext\images\2022-08-04-09-44-24-image.png?msec=1661755632539)​，也即这张图中的状态：

![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-04-09-44-50-image.png?msec=1661755632577)

    如前文分析，此时的电压矢量为AO方向，大小为$Udc$，我们把这个矢量画在坐标轴中如图：

![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-04-09-45-49-image.png?msec=1661755632560)

                                               ABC坐标系和αβ坐标系下的矢量表示

> 注意上图中的(100)矢量方向和AO方向是相反的（变成OA方向），这跟正方向的定义有关，这样的规定更直观一些。  
> 同时可以注意到两个零矢量其实和原点重合了，因为这两个状态下电机中产生力矩的磁场为0（不考虑旋转过程中的反电动势产生的阻力力矩）。

    同理，上图中还可以看出其余5个空间电压矢量，它们的端点组成了一个正六边形，同时把平面划分成了六个扇区（也就是图中的Ⅰ、Ⅱ、Ⅲ、Ⅳ、Ⅴ、Ⅵ）。

**那么这里问题就来了：由这6个空间电压矢量只能产生6个方向的力矩啊，我们怎么产生任意方向的力矩呢？**

# 1.5 SVPWM技术

    既然是“矢量控制”，当然是有办法的，答案就是：**使用这6个空间电压矢量作为基向量来合成任意矢量**。在每一个扇区，选择相邻两个电压矢量以及零矢量，按照**伏秒平衡原则**来合成每个扇区内的任意电压矢量，即：

![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-04-09-48-28-image.png?msec=1661755632540)

    离散化后等效为下式:

![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-04-09-50-38-image.png?msec=1661755632540)

    式子中的 $Uref$ 是我们期望得到的电压矢量，$T$ 是一个**PWM**周期。

    $Ux$ 和$ Uy$ 分别是用于合成 $Uref$ 的两个空间电压矢量，也就是上面说的6个基向量中的两个，至于是哪两个？这跟$ Uref $所在的扇区有关，比如 $Uref$ 在 $Ⅰ$ 扇区，那么$ Ux$ 和 $Uy$ 就是 $U4$ 和 $U6$ ；$ Tx $和 $Ty$ 就是在一个周期 $T$ 中 $Ux$ 和$ Uy$ 所占的时间。

    $U0$*指的是两个零矢量，可以是 $U0$ 也可以是 $U7$ ，零矢量的选择比较灵活，通过合理地配置零矢量可以让空间电压矢量的切换更平顺，后面会做说明。

    所以上面公式的含义就是：**我们可以周期性地在不同空间电压矢量之间切换，只要合理地配置不同基向量在一个周期中的占空比，就可以合成出等效的任意空间电压矢量了。**

    是不是跟**PWM**的思想完全一样呢，这也是为什么这个方法被成为**SVPWM**（空间电压矢量脉宽调制）。

    下面举一个栗子，假设我们要合成图中所示的 $Uref$，在Ⅰ扇区：

![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-04-09-57-38-image.png?msec=1661755632540)

    显然我们可以通过 $U4$ 和 $U6$ 来合成 $Uref$ ，那么如图将 $Uref$ 投影分解到 $U4$ 和 $U6$ 的方向，由正弦定理有:

    ![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-04-09-59-33-image.png?msec=1661755632541)

    又因为 ![](file://C:\Users\s50027046\AppData\Roaming\marktext\images\2022-08-04-09-59-50-image.png?msec=1661755632541) ，所以可以计算得到 $T4$ 和 $T6$ ：

    ![](file://C:\Users\s50027046\AppData\Roaming\marktext\images\2022-08-04-10-00-20-image.png?msec=1661755632541)

    其中m为SVPWM的调制系数（即调制比）： ![](file://C:\Users\s50027046\AppData\Roaming\marktext\images\2022-08-04-10-00-50-image.png?msec=1661755632541) 

> 显然在电流环控制过程中m设置得越大代表了期望力矩越大。

    而零矢量分配的时间为： ![](file://C:\Users\s50027046\AppData\Roaming\marktext\images\2022-08-04-10-01-00-image.png?msec=1661755632542) 

> 为什么 $T0=T7$ ？这是我们将PWM波形设定为中央对齐模式对称配置零矢量的结果，后面会提到。

    现在一个周期内所有状态的持续时间我们都得到了，还差一个顺序，也就是**各个状态切换的顺序**。

> **问题：难道不是任意顺序都可以嘛？反正是做积分，重要的是持续时间而不是顺序，一个周期内怎么切换都行啊。**

    是的，理论上任何切换顺序都是ok的，但是实际中我们需要考虑更多限制，比如因为MOS管存在开关损耗，**我们希望能尽量减少MOS管的开关次数**，那么以最大限度减少开关损耗为目的，我们就可以设计出下面的切换顺序：

![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-04-10-07-05-image.png?msec=1661755632542)

    上图中可以看出来，在每个状态切换的时候，都只有一个相发生了转变：**000->100->110->111->110->100->000**，这也是所谓的七段式SVPWM调制法。

    同时我们通过在合理的位置插入两个零矢量，并且对零矢量在时间上进行了平均分配，以使产生的PWM对称，从而有效地降低了PWM的谐波分量。

    同理，我们也可以列出在其他扇区时的切换顺序：

![](file:///C:/Users/s50027046/AppData/Roaming/marktext/images/2022-08-04-10-14-45-image.png?msec=1661755632562)

    至此，SVPWM的工作完成了，我们得到了每一时刻所需要的空间电压矢量以及它们持续的时间，在处理器中赋值给对应通道的捕获比较寄存器产生相应的三个PWM波形，控制MOS管的开关，进而产生我们期望的电压、电流、力矩。
